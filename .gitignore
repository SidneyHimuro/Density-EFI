import dash
from dash import dcc, html
from dash.dependencies import Input, Output
import plotly.graph_objects as go
import serial
import threading
import time

# ================= CONFIG SERIAL =================
SERIAL_PORT = "COM7"
SERIAL_BAUD = 115200

serial_data = {"RPM": 0, "MAP": 0.0, "TPS": 0.0, "TINJ": 0.0}

def serial_reader():
    global serial_data
    try:
        ser = serial.Serial(SERIAL_PORT, SERIAL_BAUD, timeout=1)
        while True:
            line = ser.readline().decode(errors="ignore").strip()
            if line:
                parts = line.split(",")
                if len(parts) == 4:
                    try:
                        serial_data["RPM"]  = float(parts[0])
                        serial_data["MAP"]  = float(parts[1])
                        serial_data["TPS"]  = float(parts[2])
                        serial_data["TINJ"] = float(parts[3])
                    except: pass
    except Exception as e:
        print(f"Erro Serial: {e}")

threading.Thread(target=serial_reader, daemon=True).start()

# ================= COMPONENTES VISUAIS =================

def create_rpm_bar(value):
    max_rpm = 8000
    color = "#2ecc71" # Verde
    if value > 4500: color = "#f1c40f" # Amarelo
    if value > 5200: color = "#e74c3c" # Vermelho

    fig = go.Figure(go.Bar(
        x=[value],
        y=["RPM"],
        orientation='h',
        marker=dict(color=color, line=dict(color="#222", width=1)),
        width=0.8
    ))

    fig.update_layout(
        xaxis=dict(range=[0, max_rpm], showgrid=False, zeroline=False, 
                   tickfont=dict(color="white", size=18, family="Arial Black")),
        yaxis=dict(visible=False),
        plot_bgcolor="rgba(0,0,0,0)",
        paper_bgcolor="rgba(0,0,0,0)",
        margin=dict(l=10, r=10, t=5, b=5),
        height=120,
    )
    return fig

def create_card_content(title, value, unit, color):
    return [
        html.Div(title.upper(), style={
            "fontSize": "22px", 
            "color": "#AAA", 
            "fontWeight": "900",
            "marginBottom": "10px"
        }),
        html.Div([
            html.Span(f"{value}", style={
                "fontSize": "64px", 
                "fontWeight": "bold", 
                "color": "white"
            }),
            html.Span(f" {unit}", style={
                "fontSize": "24px", 
                "color": color, 
                "fontWeight": "bold",
                "marginLeft": "10px"
            })
        ])
    ]

# ================= LAYOUT DASH =================

app = dash.Dash(__name__)

app.layout = html.Div(style={
    "backgroundColor": "#000", 
    "color": "white", 
    "minHeight": "100vh", 
    "padding": "30px",
    "fontFamily": "Arial, sans-serif"
}, children=[
    
    # RPM SECTION
    html.Div(style={
        "border": "3px solid #444", 
        "borderRadius": "12px", 
        "padding": "20px", 
        "marginBottom": "30px",
        "backgroundColor": "#050505"
    }, children=[
        html.Div("RPM", style={
            "textAlign": "center", 
            "fontSize": "28px", 
            "fontWeight": "bold", 
            "color": "white",
            "marginBottom": "10px"
        }),
        dcc.Graph(id="rpm-bar-graph", config={'displayModeBar': False}),
    ]),

    # CARDS SECTION
    html.Div(style={
        "display": "flex", 
        "justifyContent": "center", 
        "gap": "20px",
        "flexWrap": "nowrap" # Mantém na mesma linha se houver espaço
    }, children=[
        html.Div(id="map-card", style={
            "flex": "1", "border": "3px solid #3498db", "borderRadius": "12px", 
            "padding": "25px", "textAlign": "center", "backgroundColor": "#0a0a0a"
        }),
        html.Div(id="tps-card", style={
            "flex": "1", "border": "3px solid #f39c12", "borderRadius": "12px", 
            "padding": "25px", "textAlign": "center", "backgroundColor": "#0a0a0a"
        }),
        html.Div(id="tinj-card", style={
            "flex": "1", "border": "3px solid #9b59b6", "borderRadius": "12px", 
            "padding": "25px", "textAlign": "center", "backgroundColor": "#0a0a0a"
        }),
    ]),

    dcc.Interval(id="ui-update-interval", interval=100)
])

# ================= CALLBACKS =================

@app.callback(
    Output("rpm-bar-graph", "figure"),
    Output("map-card", "children"),
    Output("tps-card", "children"),
    Output("tinj-card", "children"),
    Input("ui-update-interval", "n_intervals")
)
def refresh_ui(n):
    rpm_fig = create_rpm_bar(serial_data["RPM"])
    
    # Formatação do MAP em bar com x.xx
    map_content = create_card_content("MAP", f"{serial_data['MAP']:.2f}", "bar", "#3498db")
    tps_content = create_card_content("TPS", f"{int(serial_data['TPS'])}", "%", "#f39c12")
    tinj_content = create_card_content("Tinj", f"{serial_data['TINJ']:.2f}", "ms", "#9b59b6")
    
    return rpm_fig, map_content, tps_content, tinj_content

if __name__ == "__main__":
    app.run(debug=False)
