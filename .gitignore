#include <LiquidCrystal.h>

// Pinos utilizados pelo LCD Keypad Shield (Padrão)
// RS = D8, EN = D9, D4 = D4, D5 = D5, D6 = D6, D7 = D7
LiquidCrystal lcd(8, 9, 4, 5, 6, 7);

// Definição dos Pinos Analógicos para os Sensores no Mega
const int pinoMAP = A1;
const int pinoTPS = A2;
const int pinoECT = A3;
const int pinoIAT = A4;
const int pinoRPM = 2; // Usando interrupção para RPM (Pino D2)

// Variáveis de controle
volatile int pulsosRPM = 0;
unsigned long tempoAnterior = 0;
int rpm = 0;

void setup() {
  lcd.begin(16, 2);
  lcd.print("Iniciando Monitor");
  delay(1000);
  lcd.clear();

  // Configuração do RPM via interrupção (subida de sinal)
  pinMode(pinoRPM, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(pinoRPM), contarPulso, RISING);
}

void loop() {
  // 1. Cálculo de RPM (atualizado a cada 1 segundo)
  if (millis() - tempoAnterior >= 1000) {
    detachInterrupt(digitalPinToInterrupt(pinoRPM)); // Pausa para cálculo
    rpm = (pulsosRPM * 60); // Ajuste conforme a qtd de pulsos por volta
    pulsosRPM = 0;
    tempoAnterior = millis();
    attachInterrupt(digitalPinToInterrupt(pinoRPM), contarPulso, RISING);
  }

  // 2. Leitura dos Sensores (Simples conversão de 0-1023)
  // Obs: Para valores reais, deve-se aplicar as fórmulas de cada sensor.
  int valMAP = analogRead(pinoMAP);
  int valTPS = map(analogRead(pinoTPS), 0, 1023, 0, 100); // Exemplo em %
  int valECT = analogRead(pinoECT);
  int valIAT = analogRead(pinoIAT);

  // 3. Exibição no LCD (Alternando informações)
  // Tela 1: RPM e MAP
  lcd.setCursor(0, 0);
  lcd.print("RPM: "); lcd.print(rpm); lcd.print("    ");
  lcd.setCursor(0, 1);
  lcd.print("MAP: "); lcd.print(valMAP); lcd.print(" TPS:"); lcd.print(valTPS); lcd.print("% ");

  // Opcional: Use os botões do Shield (A0) para trocar de tela
  int botao = analogRead(A0);
  if (botao < 50) { // Botão RIGHT pressionado
     exibirTelaTemperaturas(valECT, valIAT);
     delay(1000); // Pausa para leitura
  }
}

void contarPulso() {
  pulsosRPM++;
}

void exibirTelaTemperaturas(int ect, int iat) {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("ECT: "); lcd.print(ect);
  lcd.setCursor(0, 1);
  lcd.print("IAT: "); lcd.print(iat);
}
