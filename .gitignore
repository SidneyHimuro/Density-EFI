import dash
from dash import dcc, html
from dash.dependencies import Input, Output
import plotly.graph_objects as go

import serial
import threading
import time

# ===================== CONFIG SERIAL =====================
SERIAL_PORT = "COM7"     # <<< MUDE AQUI
SERIAL_BAUD = 115200

# ===================== DADOS GLOBAIS =====================
serial_data = {
    "RPM": 0,
    "MAP": 0.0,
    "TPS": 0.0,
    "TINJ": 0.0
}

# ===================== THREAD SERIAL =====================
def serial_reader():
    global serial_data

    try:
        ser = serial.Serial(SERIAL_PORT, SERIAL_BAUD, timeout=1)
        time.sleep(2)
        print(f"[SERIAL] Conectado em {SERIAL_PORT}")

        while True:
            line = ser.readline().decode(errors="ignore").strip()
            if not line:
                continue

            parts = line.split(",")
            if len(parts) != 4:
                continue

            try:
                serial_data["RPM"]  = float(parts[0])
                serial_data["MAP"]  = float(parts[1])
                serial_data["TPS"]  = float(parts[2])
                serial_data["TINJ"] = float(parts[3])
            except ValueError:
                pass

    except Exception as e:
        print("[SERIAL] Erro:", e)

# ===================== DASH APP =====================
app = dash.Dash(__name__)
app.title = "Dash700 Speeduino"

# Inicia thread serial
threading.Thread(target=serial_reader, daemon=True).start()

# ===================== GAUGE RPM =====================
def rpm_gauge(value):
    return go.Figure(go.Indicator(
        mode="gauge+number",
        value=value,
        number={"font": {"size": 48}},
        gauge={
            "axis": {"range": [0, 8000]},
            "bar": {"thickness": 0.25},
            "steps": [
                {"range": [0, 3000], "color": "#2ecc71"},
                {"range": [3000, 6000], "color": "#f1c40f"},
                {"range": [6000, 8000], "color": "#e74c3c"},
            ],
            "threshold": {
                "line": {"color": "red", "width": 4},
                "thickness": 0.75,
                "value": 6500
            }
        },
        title={"text": "RPM"}
    ))

# ===================== LAYOUT =====================
app.layout = html.Div(
    style={
        "backgroundColor": "#111",
        "color": "white",
        "fontFamily": "Arial"
    },
    children=[

        html.H2("Dash700 â€“ Speeduino Style", style={"textAlign": "center"}),

        dcc.Graph(
            id="rpm-gauge",
            figure=rpm_gauge(0),
            style={"height": "420px"}
        ),

        html.Div(
            style={
                "display": "flex",
                "justifyContent": "space-around",
                "marginTop": "10px"
            },
            children=[
                html.Div(id="map-box", style={"fontSize": "22px"}),
                html.Div(id="tps-box", style={"fontSize": "22px"}),
                html.Div(id="tinj-box", style={"fontSize": "22px"}),
            ]
        ),

        dcc.Interval(
            id="update-interval",
            interval=100,   # 10 Hz
            n_intervals=0
        )
    ]
)

# ===================== CALLBACK =====================
@app.callback(
    Output("rpm-gauge", "figure"),
    Output("map-box", "children"),
    Output("tps-box", "children"),
    Output("tinj-box", "children"),
    Input("update-interval", "n_intervals")
)
def update_dashboard(n):
    rpm  = serial_data["RPM"]
    map_ = serial_data["MAP"]
    tps  = serial_data["TPS"]
    tinj = serial_data["TINJ"]

    return (
        rpm_gauge(rpm),
        f"MAP: {map_:.2f} bar",
        f"TPS: {tps:.0f} %",
        f"Tinj: {tinj:.2f} ms"
    )

# ===================== MAIN =====================
if __name__ == "__main__":
    app.run(debug=False)
